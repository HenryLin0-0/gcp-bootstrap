# Cloud Build è¨­å®šæª”ï¼Œç”¨æ–¼åŸ·è¡Œ Terraform init, plan, å’Œ apply

# -------------------------------------------------------------
# é å®šç¾©çš„æ›¿æ›è®Šæ•¸ (SUBSTITUTIONS) 
# é€™äº›è®Šæ•¸æ‡‰ç”± Cloud Build Trigger æˆ–æ‰‹å‹•é‹è¡Œæ™‚æä¾›ã€‚
# -------------------------------------------------------------
substitutions:
  # åŸ·è¡Œ Terraform çš„æœå‹™å¸³æˆ¶ (ä¾†è‡ªæ‚¨çš„ log åˆ†æ)
  _TF_SA_EMAIL: "cloudbuild-sa@gcp-prj-sys-cicd-dev.iam.gserviceaccount.com" 
  # é ç«¯ç‹€æ…‹ Bucket åç¨± (ä¾†è‡ªæ‚¨çš„ GCS é…ç½®)
  _STATE_BUCKET_NAME: "gcp-prj-tfstate-1111" 
  # Artifact Bucket åç¨±
  _ARTIFACT_BUCKET_NAME: "gcp-prj-tfstate-1111" 
  # Terraform Runner æ˜ åƒæª” (ä½¿ç”¨å®˜æ–¹)
  _TF_IMAGE: "hashicorp/terraform:1.7.0"

timeout: '1200s'

steps:
# æ­¥é©Ÿ 1: è¨­å®šç’°å¢ƒ (åŒ…æ‹¬æœå‹™å¸³æˆ¶å†’å……å’Œå¾Œç«¯é…ç½®)
- id: 'Setup-Environment'
  # ä½¿ç”¨ gcloud æ˜ åƒä¾†è™•ç†èªè­‰å’Œ GCS ç›¸é—œæ“ä½œ
  name: 'gcr.io/cloud-builders/gcloud' 
  dir: 'terraform'
  entrypoint: /bin/bash
  args:
    - -c
    - |
      echo "--- 1. è¨­å®šæœå‹™å¸³æˆ¶å†’å…… ---"
      tf_sa_email=${_TF_SA_EMAIL}
      if [[ -n ${tf_sa_email} ]]; then
        # é…ç½® gcloud ä½¿ç”¨æŒ‡å®šçš„ SA ä¾†ç²å–ä»¤ç‰Œ
        gcloud config set auth/impersonate_service_account $tf_sa_email
      fi
      
      echo "--- 2. æº–å‚™å¾Œç«¯é…ç½® ---"
      # (å¯é¸ï¼šå¦‚æœä½ çš„ backend.tf ä¸­éœ€è¦å‹•æ…‹æ›¿æ›)
      # for i in `find -name 'backend.tf'`; do sed -i 's/UPDATE_ME/${_STATE_BUCKET_NAME}/' $i; done
      
# æ­¥é©Ÿ 2: åˆå§‹åŒ– Terraform (tf init)
- id: 'Init'
  # ä½¿ç”¨æ›¿æ›è®Šæ•¸ä¾†å®šç¾©æ˜ åƒåç¨±
  name: ${_TF_IMAGE} 
  dir: 'terraform'
  args:
    - 'init'
    - '-input=false'
    # ğŸš¨ æ¨è–¦åšæ³•ï¼šå°‡å¾Œç«¯é…ç½®å¾é€™è£¡ç§»é™¤ï¼Œæ”¹ç‚ºå®šç¾©åœ¨ main.tf/versions.tf ä¸­
    #    Cloud Build æœƒè‡ªå‹•å¾é‚£è£¡è®€å– Bucket åç¨±ï¼Œæˆ–ä½¿ç”¨ -backend-configã€‚
    #    é€™è£¡ä½¿ç”¨ -backend-configï¼Œç¢ºä¿å®ƒè¦†è“‹ä»»ä½•éœæ…‹é…ç½®
    - '-backend-config=bucket=${_STATE_BUCKET_NAME}'
    - '-backend-config=prefix=terraform/projects/state'
  waitFor: ['Setup-Environment']

# æ­¥é©Ÿ 3: å»ºç«‹åŸ·è¡Œè¨ˆåŠƒ (tf plan)
- id: 'Plan'
  name: ${_TF_IMAGE}
  dir: 'terraform'
  args:
    - 'plan'
    - '-input=false'
    - '-out=tfplan'
  waitFor: ['Init']

# æ­¥é©Ÿ 4: æ‡‰ç”¨åŸ·è¡Œè¨ˆåŠƒ (tf apply)
- id: 'Apply'
  name: ${_TF_IMAGE}
  dir: 'terraform'
  args:
    - 'apply'
    - '-input=false'
    - '-auto-approve' # ğŸš¨ åœ¨ apply éšæ®µï¼Œé€™æ‡‰åƒ…ç”¨æ–¼ CI/CD éƒ¨ç½²
    - 'tfplan'
  # é€™è£¡ä½¿ç”¨ 'Plan' çš„è¼¸å‡ºæª”æ¡ˆ
  waitFor: ['Plan'] 

# å°‡ tfplan æª”æ¡ˆæŒ‡å®šç‚ºæ§‹å»ºå·¥ä»¶
artifacts:
  objects:
    # ä½¿ç”¨æ›¿æ›è®Šæ•¸ä¾†å®šç¾©å„²å­˜è·¯å¾‘
    location: 'gs://${_ARTIFACT_BUCKET_NAME}/terraform-artifacts/${BUILD_ID}/'
    # ç¢ºä¿è·¯å¾‘èˆ‡ dir: 'terraform' ç›¸å°
    paths: ['terraform/tfplan']

# è™•ç† Cloud Build æœå‹™å¸³æˆ¶çš„æ—¥èªŒé¸é … (å¦‚æœæ‚¨çš„è§¸ç™¼å™¨æœ‰è‡ªå®šç¾© SA)
options:
  logging: 'CLOUD_LOGGING_ONLY'

timeout: '1200s'
