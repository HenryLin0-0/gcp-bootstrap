timeout: 1200s
steps:
  - id: 'setup'
    name: $_DEFAULT_REGION-docker.pkg.dev/$PROJECT_ID/$_GAR_REPOSITORY/terraform
    entrypoint: /bin/bash
    args:
      - -c
      - |
        tf_sa_email=${_TF_SA_EMAIL}
        if [[ -n ${tf_sa_email} ]]; then
          echo "Setting up gcloud for impersonation"
          gcloud config set auth/impersonate_service_account $tf_sa_email
        fi
        echo "Adding bucket information to backends"
        for i in `find -name 'backend.tf'`; do sed -i 's/UPDATE_ME/${_STATE_BUCKET_NAME}/' $i; done
  - id: 'tf init'
    name: $_DEFAULT_REGION-docker.pkg.dev/$PROJECT_ID/$_GAR_REPOSITORY/terraform
    entrypoint: /bin/bash
    args:
      - -c
      - |
        terraform init
  - id: 'tf plan'
    name: $_DEFAULT_REGION-docker.pkg.dev/$PROJECT_ID/$_GAR_REPOSITORY/terraform
    entrypoint: /bin/bash
    args:
      - -c
      - |
        terraform plan -input=false -out "$REPO_NAME.tfplan"
artifacts:
  objects:
    location: 'gs://${_ARTIFACT_BUCKET_NAME}/terraform/cloudbuild/plan/${BUILD_ID}'
    paths: ['cloudbuild-tf-plan.yaml', '$REPO_NAME.tfplan']
